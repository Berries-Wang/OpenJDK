# Codecache Tuning(Codecache 调优)
&nbsp;&nbsp;This chapter describes techniques for reducing the just-in-time (JIT) compiler's consumption of memory in the codecache, where it stores compiled methods. This chapter contains the following topics:
> JIT将编译后的代码存储在Codecache中.本章描述如何减少JIT编译器在Codecache中所消耗的内存，本章包含如下主题:

+ Introduction
+ java Launcher Codecache Option Summary
+ Measuring Codecache Usage
+ Constraining the Codecache Size
+ Reducing Compilations
+ Reducing Compiled Method Sizes

## Introduction
&nbsp;&nbsp;The Java Virtual Machine (JVM) generates native code and stores it in a memory area called the codecache. The JVM generates native code for a variety of reasons, including for the dynamically generated interpreter loop, Java Native Interface (JNI) stubs, and for Java methods that are compiled into native code by the just-in-time (JIT) compiler. The JIT is by far the biggest user of the codecache. This appendix describes techniques for reducing the JIT compiler's codecache usage while still maintaining good performance.
> 译: JVM生成native code并把它存储在一个叫做codecache的内存区域，JVM产生native code有各式各样的原因，包括动态生成的解释器循环，JNI存根以及被JIT编译器编译成native code的Java方法。到目前为止，JIT是codecache最大的用户.这个附录描述了减少JIT编译器所占的codecache空间并且依旧维持他性能高效的技术。

&nbsp;&nbsp;This chapter describes three ways to reduce the JIT's use of the codecache:
> 译: 本章描述了三种方式去减少JIT所用的codecache空间

- Constrain the amount of codecache available to the JIT.
  > 限制JIT可用的codecache的数量
- Tune the JIT to compile fewer methods.
  > 调整JIT以编译更少的方法
- Tune the JIT to generate less code per method.
  > 调整JIT为每个方法生成更少的代码

## java Launcher Codecache Option Summary<sub>Java 启动器Codecache选项概要</sub>
&nbsp;&nbsp;The JVM options passed by the java launcher listed in the tables in this section can be used to reduce the amount of codecache used by the JIT. The table descriptions are summaries. Most of the options are described in more detail in the sections that follow.
> 由Java启动器传递的JVM选项在本节的表中列出，这些选项可以用来减少JIT所使用的codecache的数量。这个表描述的是概要。本节后面的部分将更详细的描述大多数选项。

## How to Use the Codecache Options of the java Command<sub>如何在Java命令行使用codecache选项</sub>
The options listed in the following sections share the following characteristics.
> 以下部分中列出的选项具有以下共同特征。

- All options are –XX options, for example, -XX:InitialCodeCacheSize=32m. Options that have true/false values are specified using + for true and - for false. For example, -XX:+PrintCodeCache sets this option to true.
  > 参数如何应用，应该都能看明白
- For any option that has "varies" listed as the default value, run the launcher with XX:+PrintFlagsFinal to see your platform's default value.
   > 对于任何选项，有 "varies" 标志就是默认值，可以运行带有“XX:+PrintFlagsFinal”的启动器去看平台默认的值
- If the default value for an option differs depending on which JVM is being used (client or server), then both defaults are listed, separated by a '/'. The client JVM default is listed first. The minimal JVM uses the same JIT as the client JVM, and therefore has the same defaults.
   >  如果选项的默认值因使用的JVM(client or server)的不同而不同，则所有的默认值都会列举出来，通过'/'分隔，client VM默认值被第一个列举出来，这个最小的JVM使用和client JVM相同的JIT，因此具有相同的默认值
### Codecache Size Options
&nbsp;&nbsp;Table 15-1 summarizes the codecache size options. See also Constraining the Codecache Size.

- &nbsp;&nbsp;Table 15-1 Codecache Size Options
  |Option|Default|Description|
  |---|---|---|
  |InitialCodeCacheSize|160K (varies)|Initial code cache size (in bytes)|
  |ReservedCodeCacheSize|32M/48M|Reserved code cache size (in bytes) - maximum code cache size|
  |CodeCacheExpansionSize|32K/64K|Code cache expansion size (in bytes)|

### Codecache Flush Options
&nbsp;&nbsp;Table 15-2 summarizes the codecache flush options.
- &nbsp;&nbsp;Table 15-2 Codecache Flush Options
   |Option|Default|Description|
   |---|---|---|
   |ExitOnFullCodeCache |false| Exit the JVM if the codecache fills|
   |UseCodeCacheFlushing |false|Attempt to sweep the codecache before shutting off compiler|
   |MinCodeCacheFlushingInterval| 30 |Minimum number of seconds between codecache sweeping sessions|
   |CodeCacheMinimumFreeSpace |500K| When less than the specified amount of space remains, stop compiling. This space is reserved for code that is not compiled methods, for example, native adapters.|

### Compilation Policy Options
&nbsp;&nbsp;Table 15-3 summarizes the compilation policy (when to compile) options.
- &nbsp;&nbsp;Table 15-3 Compilation Policy Options
  |Option|Default|Description|
  |---|---|---|
  |CompileThreshold|1000 or 1500/10000|Number of interpreted method invocations before (re-)compiling|
  |OnStackReplacePercentage|140 to 933|NON_TIERED number of method invocations/branches (expressed as a percentage of CompileThreshold) before (re-)compiling OSR code|

### Compilation Limit Options
&nbsp;&nbsp;Table 15-4 summarizes the compilation limit options, which determine how much code is compiled).

- &nbsp;&nbsp;Table 15-4 Compilation Limit Options
  |Option|Default|Description|
  |---|---|---|
  |MaxInlineLevel|9|Maximum number of nested calls that are inlined|
  |MaxInlineSize|35|Maximum bytecode size of a method to be inlined |
  |MinInliningThreshold|250|Minimum invocation count a method needs to have to be inlined|
  |InlineSynchronizedMethods|true|Inline synchronized methods|

### Diagnostic Options
&nbsp;&nbsp;Table 15-5 summarizes the diagnostic options.

- &nbsp;&nbsp;Table 15-5 Diagnostic Options
  |Option|Default|Description|
  |---|---|---|
  |PrintFlagsFinal|false|Print all JVM options after argument and ergonomic processing|
  |PrintCodeCache|false|Print the code cache memory usage when exiting|
  |PrintCodeCacheOnCompilation|false|Print the code cache memory usage each time a method is compiled|

## Measuring Codecache Usage
&nbsp;&nbsp;To measure the success of a codecache usage reduction effort, you must measure the codecache usage and the effect on performance. This section explains how to measure the codecache usage. It is up to you to decide the best way to measure performance for your application.
> 为了能够成功的测量减少codecache使用量的成果，你必须测量codecache的使用情况及其对性能的影响，本章解释了如何去测量codecache的使用情况，将由你决定测量你应用程序性能最好的方式。

&nbsp;&nbsp;Start with a baseline (the amount of codecache used when no codecache reduction techniques are applied), and then monitor the effect of your codecache reduction techniques on both codecache size and performance relative to the baseline.
> 从一个基线开始（没有应用codecache缩减技术时codecache的使用数量），然后相对于基线监测codecache缩减技术对于codecache大小和性能的影响

&nbsp;&nbsp;Keep in mind that the codecache starts relatively small and then grows as needed as new methods are compiled. Sometimes compiled methods are freed from the codecache, especially when the maximum size of the codecache is constrained. The memory used by free methods can be reused for newly compiled methods, allowing additional methods to be compiled without growing the codecache further.
> 记住，codecache开始很小然后随着新方法的编译而增长，有时编译后的方法会从codecache中释放，特别是在codecache的最大值被限制的时候。"free methods"所占用的内存将被新编译的方法所重用，从而允许在编译其他方法的时候而不需要增长codecache空间.
> > free methods : 是啥
> > 即codecache空间的复用

&nbsp;&nbsp;You can get information on codecache usage by specifying –XX:+PrintCodeCache on the java launcher command line. When your application exits, you will see output similar to the following:
 ```txt
    CodeCache: size=32768Kb used=542Kb max_used=542Kb free=32226Kb
     bounds [0xb414a000, 0xb41d2000, 0xb614a000] 
     total_blobs=131 nmethods=5 adapters=63 
     compilation: enabled
 ```

---
## 附录
### 1. 起因
<img src="./pics/2021-12-23_23-21.png">

- code_cache：JIT缓存区域占用内存信息
- metaspace：元数据区占用内存信息（受操作系统内存大小的限制）
- compressed_class_space：指针压缩 用32位的offset代表64位的classpointer
- direct： Direct Memory,nio使用的堆外空间
- mapped：内存映射缓冲区（一般来说频繁读写文件可能导致此区域偏高）系统信息区域（内存映射文件,nio使用）

---
## 参考资料
1. 原文: [15 Codecache Tuning](https://docs.oracle.com/javase/jp/8/embedded/develop-apps-platforms/codecache.htm)

-----
## 哈哈，蹩脚的翻译
|单词|中文|
|---|---|
|variety|多样化，变化；种类，品种；（人或物的）各式各样；综艺表演，杂耍表演|
|dynamically|adv. 动态地；充满活力地；不断变化地|
|far|adv. 远，遥远地；久远地；非常，很大程度上；发展，进展（到）；过分地；adj. 遥远的，久远的；另一边的，较远的；偏远的，极端的|
|by far|到目前为止|
|appendix|附录，阑尾|
|techniques|n. 技术；方法；技巧（technique 的复数）|
|maintaining|n. 维护；保养;v. 维持；保养（maintain 的现在分词）|
|Constrain|v. 限制，约束；强迫，迫使|
|Summary|n. 总结，概要|
|characteristics|n. 特性，特征；特色（characteristic 的复数）；特质|
|varies|v. （大小、形状等）不同；改变；略微变更，调整（vary 的第三人称单数）|
|expansion|n. 扩大，扩张；扩充，展开；扩张物；膨胀|
|Measuring|v. 测量（measure 的 ing 形式）|
|effort|n. 努力，艰难的尝试；力气，精力；有组织的活动；努力的结果，成就；努力的结果，成就|
|measure|v.测量；估量；|
|It is up to you|由你决定;取决于你;