# 物理CPU-OS执行流程
> 先阅读:[揭秘Java虚拟机#第9章：执行引擎](./../../006.BOOKs/Unlocking-The-Java-Virtual-Machine/009.Unlocking-The-Java-Virtual-Machine-9.pdf)

物理CPU执行指令的流程:
1. 取指。
    - CPU的控制器从内存(代码段)读取一条指令放入指令寄存器。`物理机器指令一般由操作码和操作数组成`,当然，并不是所有的操作码都会有操作数。
      ```txt
        机器指令:  mov ax,1  
                   mov ax 是操作码 
                   1  操作数
        在Intel处理器上，这条指令对应的十六进制数： 0xB8 01
      ```
2. 译码。
    - 指寄存器中的指令经过译码，确定该指令应进行何种操作（由操作码决定），操作数在哪里(由操作数决定)
3. 执行
    - 分两个阶段： 取操作数 和 进行运算
4. 取下一条指令。
    - 修改指令计数器(亦称程序计数器)，计算下一条指令的地址<sub>P519: CPU只有知道一个操作码后面是否跟随操作数，以及所跟随的操作数的大小，才能计算下一条指令的位置，从而完成取址操作</sub>，并重新进入取址、译码和执行的循环


操作系统会将软件程序的二进制机器指令全部读进代码段中，当操作系统开始执行该软件程序时，CPU便会读取代码段中的第一条机器指令，然后进行 译码 -> 执行 -> 取下一条指令 -> 译码 -> 执行的循环，直到执行完该程序。

### 取指关键 <sup>怎么计算下一条指令的地址</sub>
所以，当 CPU 在执行一段程序时，一定是先读取程序中的第一条指令的操作码并进行译码，计算该操作码后面是否跟随操作数以及操作数的数据宽度，如此 CPU 才能计算出下一条指令的起始位置并读取下一条指令中的操作码，然后继续译码，继续计算下一条指令的起始位置......，如此循环往复 。 这便是“取指”的关键所在。


只要操作系统一启动，CPU便会一直循环往复地执行上述流程（取指 -> 译码 -> 执行 -> 去下一条指令）,当机器什么事也不干的时候，会进入空转状态，但是不会停止。


## 基础知识了解
### 段式内存管理架构
- 操作系统将程序加载到内存后，会将编译后的二进制代码指令存储到一个专门的区域——`代码段`
  + CPU取指时，先从程序的代码段读取出操作码，在译码阶段，译码逻辑会判断该操作码，并从代码段中读取其对应的操作数。 


### 物理机器完成程序运行，得
1. 内存中存储软件程序编译后的指令
2. CPU要能够识别出代码段中的指令和操作数.
