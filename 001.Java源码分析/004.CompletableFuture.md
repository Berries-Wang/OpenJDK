# [CompletableFuture](../005.OpenJDK/002.OpenJDK8u312-GA/OpenJDK8U312-GA/jdk/src/share/classes/java/util/concurrent/CompletableFuture.java)



## 附录
### Treiber stack
&nbsp;&nbsp;The Treiber stack algorithm is a scalable<sup>可拓展的</sup> lock-free stack utilizing<sup>v.利用（utilize 的 ing 形式）</sup> the fine-grained<sup>adj.细粒的；有细密纹理的；详细的；深入的</sup> concurrency primitive<sup>n.（计算机）图元，原语</sup> compare-and-swap. It is believed that R. Kent Treiber was the first to publish it in his 1986 article "Systems Programming: Coping with Parallelism"

#### Basic principle(基本原理)
&nbsp;&nbsp;The basic principle<sup>n.（机器等或自然界的）原理，定律；</sup> for the algorithm is to only add something new to the stack once you know the item you are trying to add is the only thing that has been added since you began the operation. This is done by using compare-and-swap. Pushing an item to the stack is done by first taking the top of the stack (old head) and placing it after your new item to create a new head. You then compare the old head to the current head. If the two are matching then you can swap old head to the new one, if not then it means another thread has added an item to the stack, in which case you must try again.

&nbsp;&nbsp;When popping an item from the stack, before returning the item you must check that another thread has not added a new item since the operation began.
#### Correctness
&nbsp;&nbsp;In some languages—particularly, those without garbage collection—the Treiber stack can be at risk for the ABA problem. When a process is about to remove an element from the stack (just before the compare and set in the pop routine below) another process can change the stack such that the head is the same, but the second element is different. The compare and swap will set the head of the stack to the old second element in the stack mixing up the complete data structure. However, the Java version on this page is not subject to this problem, because of the stronger guarantees offered by the Java runtime (it is impossible for a newly created, unaliased object reference to be reference-equal to any other reachable object.)

&nbsp;&nbsp;Testing for failures such as ABA can be exceedingly difficult, because the problematic sequence of events is very rare. Model checking is an excellent way to uncover such problems. See for instance exercise 7.3.3 in "Modeling and analysis of communicating Systems".[3]
#### Example
&nbsp;&nbsp;Below is an implementation of the Treiber Stack in Java, based on the one provided by Java Concurrency in Practice [4]

## 参考资料
1. [CompletableFuture原理与实践-外卖商家端API的异步化](https://tech.meituan.com/2022/05/12/principles-and-practices-of-completablefuture.html)